- name: Vypis VNC pristup pro jeden virtual
  hosts: all
  gather_facts: false
  vars:
    show_vms: true
    vm: ""

  tasks:
    - name: Zkontroluj, ze je zadany cilovy virtual
      ansible.builtin.fail:
        msg: "Set vm (e.g. -e vm=mjaa55.hlubina.com)"
      when: show_vms and (vm | trim | length == 0)

    - name: Ziskej VNC display pro cilovy virtual (virsh domdisplay)
      ansible.builtin.command: "virsh domdisplay --include-password {{ vm }}"
      register: virsh_display
      changed_when: false
      failed_when: false
      when: show_vms and (vm | trim | length > 0)

    - name: Sestav info o VNC pro cilovy virtual
      ansible.builtin.set_fact:
        vnc_info:
          name: "{{ vm }}"
          vnc_port: "{{ vnc_port }}"
          vnc_passwd: "{{ vnc_passwd }}"
          display: "{{ display }}"
      vars:
        display: "{{ virsh_display.stdout | default('') | trim }}"
        vnc_port: "{{ (display | regex_search(':(\\d+)$') | default('')) | regex_replace('^:', '') | default('n/a') }}"
        vnc_passwd: "{{ (display | regex_search('vnc://:([^@]+)@') | default('')) | regex_replace('^vnc://:', '') | regex_replace('@$', '') | default('n/a') }}"
      when: show_vms and (vm | trim | length > 0)

    # Single-line output for copy/paste into a shell.
    - name: Vypis prikazy pro vncviewer
      ansible.builtin.debug:
        msg: "export VNC_PASSWORD={{ vnc_info.vnc_passwd | quote }} && vncviewer {{ ansible_host | default(inventory_hostname) }}:{{ vnc_info.vnc_port }}"
      when: show_vms and (vm | trim | length > 0)
