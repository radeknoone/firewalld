- name: Print VNC access for one VM
  hosts: all
  gather_facts: false
  vars:
    show_vms: true
    vm: ""

  tasks:
    - name: Require target VM name
      ansible.builtin.fail:
        msg: "Set vm (e.g. -e vm=mjaa55.hlubina.com)"
      when: show_vms and (vm | trim | length == 0)

    - name: Fetch VNC display for target VM (virsh domdisplay)
      ansible.builtin.command: "virsh domdisplay --include-password {{ vm }}"
      register: virsh_display
      changed_when: false
      failed_when: false
      when: show_vms and (vm | trim | length > 0)

    # Treat missing display as a hard error to avoid emitting a bogus command.
    - name: Fail when VM is missing or has no VNC
      ansible.builtin.fail:
        msg: "VM {{ vm }} not found or no VNC display"
      when: >
        show_vms and
        (vm | trim | length > 0) and
        (
          (virsh_display.rc | default(1) | int) != 0 or
          (virsh_display.stdout | default('') | trim | length == 0)
        )

    - name: Build VNC info for target VM
      ansible.builtin.set_fact:
        vnc_info:
          name: "{{ vm }}"
          vnc_port: "{{ vnc_port }}"
          vnc_passwd: "{{ vnc_passwd }}"
          display: "{{ display }}"
      vars:
        display: "{{ virsh_display.stdout | default('') | trim }}"
        vnc_port: "{{ (display | regex_search(':(\\d+)$') | default('')) | regex_replace('^:', '') | default('n/a') }}"
        vnc_passwd: "{{ (display | regex_search('vnc://:([^@]+)@') | default('')) | regex_replace('^vnc://:', '') | regex_replace('@$', '') | default('n/a') }}"
      when: show_vms and (vm | trim | length > 0)

    # Single-line output for copy/paste into a shell.
    - name: Print vncviewer command
      ansible.builtin.debug:
        msg: "export VNC_PASSWORD={{ vnc_info.vnc_passwd | quote }} && vncviewer {{ ansible_host | default(inventory_hostname) }}:{{ vnc_info.vnc_port }}"
      when: show_vms and (vm | trim | length > 0)
